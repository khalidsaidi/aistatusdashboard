name: Discovery Uptime Checks

on:
  schedule:
    - cron: "17 * * * *" # hourly-ish to spread load
  workflow_dispatch:

jobs:
  check-endpoints:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Check discovery endpoints
        run: |
          set -euo pipefail
          endpoints=(
            "https://aistatusdashboard.com/llms.txt"
            "https://aistatusdashboard.com/llms-full.txt"
            "https://aistatusdashboard.com/robots.txt"
            "https://aistatusdashboard.com/sitemap.xml"
            "https://aistatusdashboard.com/rss.xml"
            "https://aistatusdashboard.com/.well-known/mcp"
            "https://aistatusdashboard.com/.well-known/mcp.json"
            "https://aistatusdashboard.com/.well-known/openapi.json"
            "https://aistatusdashboard.com/.well-known/openapi.yaml"
            "https://aistatusdashboard.com/openapi.json"
            "https://aistatusdashboard.com/openapi.yaml"
            "https://aistatusdashboard.com/.well-known/ai-plugin.json"
            "https://aistatusdashboard.com/docs/agent/mcp-quickstart"
            "https://aistatusdashboard.com/docs/agent/mcp-quickstart.md"
            "https://registry.modelcontextprotocol.io/v0.1/servers/io.github.aistatusdashboard%2Faistatusdashboard/versions/latest"
          )
          fail=false
          for url in "${endpoints[@]}"; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$url" || true)
            echo "$code $url"
            if [ "$code" -lt 200 ] || [ "$code" -ge 300 ]; then
              fail=true
            fi
          done
          # MCP initialize sanity
          init_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"client_info":{"name":"gha","version":"1.0"},"capabilities":{}}}' \
            https://aistatusdashboard.com/mcp || true)
          echo "$init_code https://aistatusdashboard.com/mcp (initialize)"
          if [ "$init_code" -lt 200 ] || [ "$init_code" -ge 300 ]; then
            fail=true
          fi
          $fail && exit 1 || exit 0
