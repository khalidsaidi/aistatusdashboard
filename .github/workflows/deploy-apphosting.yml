name: Deploy App Hosting

on:
  workflow_dispatch:
  push:
    branches: [main, develop]

concurrency:
  group: apphosting-deploy
  cancel-in-progress: false

jobs:
  status-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      STATUS_CHECK_BASE_URL: ${{ secrets.STATUS_CHECK_BASE_URL || 'https://aistatusdashboard.com' }}
      APP_CRON_SECRET: ${{ secrets.APP_CRON_SECRET }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Run Status Accuracy Audit (strict)
        run: |
          set +e
          node scripts/status-accuracy-check.js --base "$STATUS_CHECK_BASE_URL" --refresh
          status=$?
          if [ "$status" -ne 0 ]; then
            echo "Status accuracy refresh failed; retrying without refresh."
            node scripts/status-accuracy-check.js --base "$STATUS_CHECK_BASE_URL"
            status=$?
          fi
          exit "$status"

  deploy:
    needs: status-audit
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Deploy App Hosting
        run: npx firebase-tools deploy --only apphosting --project ai-status-dashboard --token "$FIREBASE_TOKEN"
